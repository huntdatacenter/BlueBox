---
# DEPENDENCIES and PACKAGES
- name: Set authorized key
  authorized_key:
    user: ubuntu
    key: '{{ item }}'
    state: present
  with_file:
    - './cluster-ssh-key.pub'
  tags: never, setupkeys
- name: Install common-packages
  apt:
    name:
      - htop
      - parallel
      - python-pip
      - python-virtualenv
      - python-setuptools
      - xz-utils
      - tabix
      - autoconf
      - automake
      - make
      - gcc
      - perl
      - zlib1g-dev
      - libbz2-dev
      - liblzma-dev
      - libcurl4-openssl-dev
      - libssl-dev
      - libperl-dev
      - libgsl0-dev
- name: Upgrade pip
  pip:
    name: pip
    state: forcereinstall
- name: Install common-packages
  apt:
    name:
      - python3-venv
      - python3-pip
- name: Upgrade pip
  pip:
    name: pip
    state: forcereinstall
    executable: pip3
- stat:
    path: "/usr/local/bin/bcftools"
  register: bcftools_installed
- block:
  - set_fact:
      version: "1.10.2"
  - file:
      dest: "/usr/local/src/bcftools"
      state: directory
      mode: '0755'
  - file:
      dest: "/usr/local/lib/bcftools"
      state: directory
      mode: '0755'
  - name: Uncompress bcftools
    unarchive:
      src: "https://github.com/samtools/bcftools/releases/download/{{ version }}/bcftools-{{ version }}.tar.bz2"
      dest: "/usr/local/src"
      remote_src: yes
      creates: "/usr/local/src/bcftools-{{version}}/README"
  - name: Build and Install bcftools
    make:
      chdir: "/usr/local/src/bcftools-{{version}}"
      target: install
      params:
        prefix: "/usr/local/lib/bcftools"
  - file:
      src: "/usr/local/lib/bcftools/bin/bcftools"
      dest: "/usr/local/bin/bcftools"
      state: link
  when: bcftools_installed.stat.exists == false
